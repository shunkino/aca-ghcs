{
  "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.38.33.27573",
      "templateHash": "4490582920236720920"
    }
  },
  "parameters": {
    "projectName": {
      "type": "string",
      "defaultValue": "aca-ghcs",
      "metadata": {
        "description": "Project prefix used to build resource names."
      }
    },
    "targetEnv": {
      "type": "string",
      "defaultValue": "dev",
      "metadata": {
        "description": "Logical environment name (for example dev, qa, prod)."
      }
    },
    "location": {
      "type": "string",
      "defaultValue": "[deployment().location]",
      "metadata": {
        "description": "Azure region used for the new resource group and its resources."
      }
    },
    "resourceGroupName": {
      "type": "string",
      "defaultValue": "[format('{0}-{1}-rg', parameters('projectName'), parameters('targetEnv'))]",
      "metadata": {
        "description": "Name of the resource group to create before deploying resources."
      }
    },
    "resourceTags": {
      "type": "object",
      "defaultValue": {},
      "metadata": {
        "description": "Tags applied to every resource in this deployment."
      }
    }
  },
  "variables": {
    "projectSegment": "[if(empty(trim(parameters('projectName'))), 'aca', toLower(replace(parameters('projectName'), ' ', '')))]",
    "envSegment": "[if(empty(trim(parameters('targetEnv'))), 'env', toLower(replace(parameters('targetEnv'), ' ', '')))]",
    "baseName": "[toLower(replace(format('{0}-{1}', variables('projectSegment'), variables('envSegment')), '--', '-'))]",
    "namingSeed": "[uniqueString(subscription().id, parameters('resourceGroupName'))]",
    "acrName": "[toLower(take(format('{0}{1}', replace(variables('baseName'), '-', ''), variables('namingSeed')), 50))]",
    "logWorkspaceName": "[toLower(take(format('{0}-logs', variables('baseName')), 63))]",
    "managedEnvName": "[toLower(take(format('{0}-env', variables('baseName')), 63))]",
    "containerAppName": "[toLower(take(format('{0}-app', variables('baseName')), 63))]",
    "acrIdentityName": "[toLower(take(format('{0}-acr-mi', variables('baseName')), 63))]"
  },
  "resources": [
    {
      "type": "Microsoft.Resources/resourceGroups",
      "apiVersion": "2024-03-01",
      "name": "[parameters('resourceGroupName')]",
      "location": "[parameters('location')]",
      "tags": "[parameters('resourceTags')]"
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "sharedResources",
      "resourceGroup": "[parameters('resourceGroupName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "resourceTags": {
            "value": "[parameters('resourceTags')]"
          },
          "logWorkspaceName": {
            "value": "[variables('logWorkspaceName')]"
          },
          "containerRegistryName": {
            "value": "[variables('acrName')]"
          },
          "managedEnvironmentName": {
            "value": "[variables('managedEnvName')]"
          },
          "acrIdentityName": {
            "value": "[variables('acrIdentityName')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.38.33.27573",
              "templateHash": "7063546465720100100"
            }
          },
          "parameters": {
            "location": {
              "type": "string",
              "metadata": {
                "description": "Azure region for deployed resources."
              }
            },
            "resourceTags": {
              "type": "object",
              "metadata": {
                "description": "Tags applied to every resource in this module."
              }
            },
            "logWorkspaceName": {
              "type": "string",
              "metadata": {
                "description": "Log Analytics workspace name."
              }
            },
            "containerRegistryName": {
              "type": "string",
              "metadata": {
                "description": "Azure Container Registry name."
              }
            },
            "managedEnvironmentName": {
              "type": "string",
              "metadata": {
                "description": "Azure Container Apps managed environment name."
              }
            },
            "acrIdentityName": {
              "type": "string",
              "metadata": {
                "description": "User-assigned managed identity name used for Container Apps to pull from ACR."
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/workspaces",
              "apiVersion": "2022-10-01",
              "name": "[parameters('logWorkspaceName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('resourceTags')]",
              "properties": {
                "retentionInDays": 30,
                "features": {
                  "enableLogAccessUsingOnlyResourcePermissions": true
                },
                "sku": {
                  "name": "PerGB2018"
                }
              }
            },
            {
              "type": "Microsoft.ContainerRegistry/registries",
              "apiVersion": "2023-07-01",
              "name": "[parameters('containerRegistryName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('resourceTags')]",
              "sku": {
                "name": "Standard"
              },
              "properties": {
                "adminUserEnabled": false,
                "policies": {
                  "quarantinePolicy": {
                    "status": "disabled"
                  },
                  "trustPolicy": {
                    "type": "Notary",
                    "status": "disabled"
                  }
                }
              }
            },
            {
              "type": "Microsoft.App/managedEnvironments",
              "apiVersion": "2024-03-01",
              "name": "[parameters('managedEnvironmentName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('resourceTags')]",
              "properties": {
                "appLogsConfiguration": {
                  "destination": "log-analytics",
                  "logAnalyticsConfiguration": {
                    "customerId": "[reference(resourceId('Microsoft.OperationalInsights/workspaces', parameters('logWorkspaceName')), '2022-10-01').customerId]",
                    "sharedKey": "[listKeys(resourceId('Microsoft.OperationalInsights/workspaces', parameters('logWorkspaceName')), '2020-08-01').primarySharedKey]"
                  }
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.OperationalInsights/workspaces', parameters('logWorkspaceName'))]"
              ]
            },
            {
              "type": "Microsoft.ManagedIdentity/userAssignedIdentities",
              "apiVersion": "2018-11-30",
              "name": "[parameters('acrIdentityName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('resourceTags')]"
            },
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.ContainerRegistry/registries/{0}', parameters('containerRegistryName'))]",
              "name": "[guid(resourceId('Microsoft.ContainerRegistry/registries', parameters('containerRegistryName')), resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('acrIdentityName')), 'acrpull')]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '7f951dda-4ed3-4680-a7ca-43fe172d538d')]",
                "principalId": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('acrIdentityName')), '2018-11-30').principalId]",
                "principalType": "ServicePrincipal"
              },
              "dependsOn": [
                "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('acrIdentityName'))]",
                "[resourceId('Microsoft.ContainerRegistry/registries', parameters('containerRegistryName'))]"
              ]
            }
          ],
          "outputs": {
            "acrLoginServer": {
              "type": "string",
              "metadata": {
                "description": "Azure Container Registry login server."
              },
              "value": "[reference(resourceId('Microsoft.ContainerRegistry/registries', parameters('containerRegistryName')), '2023-07-01').loginServer]"
            },
            "containerRegistryId": {
              "type": "string",
              "metadata": {
                "description": "Azure Container Registry resource ID."
              },
              "value": "[resourceId('Microsoft.ContainerRegistry/registries', parameters('containerRegistryName'))]"
            },
            "managedEnvironmentName": {
              "type": "string",
              "metadata": {
                "description": "Azure Container Apps managed environment name."
              },
              "value": "[parameters('managedEnvironmentName')]"
            },
            "managedEnvironmentId": {
              "type": "string",
              "metadata": {
                "description": "Azure Container Apps managed environment resource ID."
              },
              "value": "[resourceId('Microsoft.App/managedEnvironments', parameters('managedEnvironmentName'))]"
            },
            "logWorkspaceId": {
              "type": "string",
              "metadata": {
                "description": "Log Analytics workspace resource ID."
              },
              "value": "[resourceId('Microsoft.OperationalInsights/workspaces', parameters('logWorkspaceName'))]"
            },
            "acrIdentityId": {
              "type": "string",
              "metadata": {
                "description": "User-assigned managed identity resource ID for Container Apps image pulls."
              },
              "value": "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('acrIdentityName'))]"
            }
          }
        }
      },
      "dependsOn": [
        "[subscriptionResourceId('Microsoft.Resources/resourceGroups', parameters('resourceGroupName'))]"
      ]
    }
  ],
  "outputs": {
    "acrName": {
      "type": "string",
      "metadata": {
        "description": "Deployed Azure Container Registry name."
      },
      "value": "[variables('acrName')]"
    },
    "acrLoginServer": {
      "type": "string",
      "metadata": {
        "description": "Azure Container Registry login server."
      },
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'sharedResources'), '2025-04-01').outputs.acrLoginServer.value]"
    },
    "containerRegistryId": {
      "type": "string",
      "metadata": {
        "description": "Azure Container Registry resource ID."
      },
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'sharedResources'), '2025-04-01').outputs.containerRegistryId.value]"
    },
    "managedEnvironmentName": {
      "type": "string",
      "metadata": {
        "description": "Azure Container Apps managed environment name."
      },
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'sharedResources'), '2025-04-01').outputs.managedEnvironmentName.value]"
    },
    "managedEnvironmentId": {
      "type": "string",
      "metadata": {
        "description": "Azure Container Apps managed environment resource ID."
      },
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'sharedResources'), '2025-04-01').outputs.managedEnvironmentId.value]"
    },
    "logWorkspaceName": {
      "type": "string",
      "metadata": {
        "description": "Log Analytics workspace name."
      },
      "value": "[variables('logWorkspaceName')]"
    },
    "logWorkspaceId": {
      "type": "string",
      "metadata": {
        "description": "Log Analytics workspace resource ID."
      },
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'sharedResources'), '2025-04-01').outputs.logWorkspaceId.value]"
    },
    "containerAppName": {
      "type": "string",
      "metadata": {
        "description": "Derived container app resource name."
      },
      "value": "[variables('containerAppName')]"
    },
    "acrIdentityName": {
      "type": "string",
      "metadata": {
        "description": "User-assigned managed identity name for ACR pulls."
      },
      "value": "[variables('acrIdentityName')]"
    },
    "acrIdentityId": {
      "type": "string",
      "metadata": {
        "description": "User-assigned managed identity resource ID for ACR pulls."
      },
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'sharedResources'), '2025-04-01').outputs.acrIdentityId.value]"
    },
    "resourceGroupName": {
      "type": "string",
      "metadata": {
        "description": "Resource group name created for the deployment."
      },
      "value": "[parameters('resourceGroupName')]"
    }
  }
}